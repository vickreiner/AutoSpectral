<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Single Cell Autofluorescence • AutoSpectral</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Single Cell Autofluorescence">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">AutoSpectral</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.8.7</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Aurora_example.html">Aurora_example</a>
    </li>
    <li>
      <a href="../articles/Cleaning.html">Cleaning</a>
    </li>
    <li>
      <a href="../articles/Control_File_example.html">Control_File_example</a>
    </li>
    <li>
      <a href="../articles/Development.html">Development</a>
    </li>
    <li>
      <a href="../articles/Full_AutoSpectral_Workflow.html">Full Workflow Example</a>
    </li>
    <li>
      <a href="../articles/Gating.html">Gating</a>
    </li>
    <li>
      <a href="../articles/Per_Cell_Optimization.html">Per Cell Optimization</a>
    </li>
    <li>
      <a href="../articles/Plotting.html">Plotting</a>
    </li>
    <li>
      <a href="../articles/Reload_AutoSpectral.html">Re-running_AutoSpectral</a>
    </li>
    <li>
      <a href="../articles/Single_Cell_AutoFluorescence.html">Single Cell Autofluorescence</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/DrCytometer/AutoSpectral/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Single Cell Autofluorescence</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/DrCytometer/AutoSpectral/blob/HEAD/vignettes/articles/Single_Cell_AutoFluorescence.Rmd" class="external-link"><code>vignettes/articles/Single_Cell_AutoFluorescence.Rmd</code></a></small>
      <div class="hidden name"><code>Single_Cell_AutoFluorescence.Rmd</code></div>

    </div>

    
    
<p>The aim of this article is to show you how to use AutoSpectral’s
per-cell autofluorescence (AF) extraction. This method selects the best
AF signature to use for each cell (or point of debris, noise, whatever)
in the data.</p>
<p>The first thing we need to do is discover all of the AF signatures
present in the data. For this, the unstained control is critical. For
good results, you need to do the following in your wet lab work: 1)
Prepare a truly unstained sample. This means no added fluorophores, so
no conjugated antibodies or live/dead stains and no fluorescent buffers
such as the Brilliant Stain buffer. This also means no fluorescent
reporters. If you run GFP expressing cells as your unstained, the GFP
signal in those will be considered an AF signature, and it will be
unmixed as autofluorescence rather than GFP. If you contaminate your
unstained with small amounts of stained cells, single-stained controls
or fluorescent beads, those signatures may also be considered to be AF
2) Treat your unstained sample like your fully stained sample. Run it
through the same protocol. If you’re fixing and permeabilizing, do that
to the unstained, too. 3) Acquire lots of cells. If you only acquire 10
thousand events, you will have very little data to work with, and rare
populations, which are probably the problematic ones, will not show up
well. Ideally, run as many cells as in your fully stained samples. 4)
Run unstained samples for each sample type in your data if you expect a
difference in AF For example, with tissue samples, run a sample from
spleen, lymph nodes and lung, not just spleen or lung. If you’re running
samples from drastically different conditions (e.g., infected
vs. healthy or infant vs. adult), I suggest running an unstained for
each. 5) For smaller differences in conditions, you will probably get
good results by creating a pooled unstained sample. For instance, when
running PBMC from multiple donors, you could take a few cells from each
for the unstained sample for AF.</p>
<p>You’re welcome to play around with breaking these rules to see what
happens.</p>
<p>A note about pooling: This can be done in the wet lab by mixing the
cells into a single tube. A safer, and likely more representative option
is to mix in silico after acquisition. This can be done by concatenating
the FCS files or by using a function such as
<code>AggregateFlowFrame()</code> from <code>FlowSOM</code>. I really,
really do not recommend concatenating with FlowJo v10 (and have not
tested v11). Also, <code>premessa</code> also does not produce FCS files
with all the information intact, so avoid that.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span> <span class="va"><a href="https://github.com/DrCytometer/AutoSpectral" class="external-link">AutoSpectral</a></span> <span class="op">)</span></span></code></pre></div>
<p>Before doing the single-cell AF extraction, you’ll need to either run
the AutoSpectral workflow to extract your fluorescence spectra or
extract the spectra using another method (e.g., FlowJo or from the Cytek
.Expt file). This is because we will use these spectra in the
determination of the AF spectra. We’re going to be looking at both the
raw and unmixed versions of the unstained sample in order to determine
how the AF signatures present are likely to interfere with the
unmixing.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">asp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get.autospectral.param.html">get.autospectral.param</a></span><span class="op">(</span> cytometer <span class="op">=</span> <span class="st">"aurora"</span>, figures <span class="op">=</span> <span class="cn">TRUE</span> <span class="op">)</span></span>
<span><span class="va">control.dir</span> <span class="op">&lt;-</span> <span class="st">"./SSC"</span></span>
<span><span class="va">control.file</span> <span class="op">&lt;-</span> <span class="st">"fcs_control_file.csv"</span></span>
<span><span class="va">flow.control</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/define.flow.control.html">define.flow.control</a></span><span class="op">(</span> <span class="va">control.dir</span>, <span class="va">control.file</span>, <span class="va">asp</span> <span class="op">)</span></span>
<span><span class="va">flow.control</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/clean.controls.html">clean.controls</a></span><span class="op">(</span> <span class="va">flow.control</span>, <span class="va">asp</span> <span class="op">)</span></span>
<span><span class="va">spectra</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get.fluorophore.spectra.html">get.fluorophore.spectra</a></span><span class="op">(</span> <span class="va">flow.control</span>, <span class="va">asp</span>, use.clean.expr <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                                    title <span class="op">=</span> <span class="st">"Clean Spectra"</span> <span class="op">)</span></span></code></pre></div>
<p>Now we are ready to get the AF spectra. For this data set, we have
spleen, lung and brain samples from mouse. We can do all three. I’ve got
the files in the <code>./SSC</code> folder, but be sure to pass the file
path as well as the file name to the first argument of
<code>get.af.spectra</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">unstained.lung</span> <span class="op">&lt;-</span> <span class="st">"G2 WT Lung_Samples.fcs"</span></span>
<span><span class="va">unstained.brain</span> <span class="op">&lt;-</span> <span class="st">"G3 WT Brain_Samples.fcs"</span></span>
<span><span class="va">unstained.spleen</span> <span class="op">&lt;-</span> <span class="st">"G1 WT Spleen_Samples.fcs"</span></span>
<span></span>
<span><span class="va">lung.af</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get.af.spectra.html">get.af.spectra</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span> <span class="va">control.dir</span>, <span class="va">unstained.lung</span> <span class="op">)</span>,</span>
<span>                           <span class="va">asp</span>, <span class="va">spectra</span>, title <span class="op">=</span> <span class="st">"Lung AF"</span> <span class="op">)</span></span>
<span><span class="va">brain.af</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get.af.spectra.html">get.af.spectra</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span> <span class="va">control.dir</span>, <span class="va">unstained.brain</span> <span class="op">)</span>, </span>
<span>                            <span class="va">asp</span>, <span class="va">spectra</span>, title <span class="op">=</span> <span class="st">"Brain AF"</span> <span class="op">)</span></span>
<span><span class="va">spleen.af</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get.af.spectra.html">get.af.spectra</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span> <span class="va">control.dir</span>, <span class="va">unstained.spleen</span> <span class="op">)</span>, </span>
<span>                             <span class="va">asp</span>, <span class="va">spectra</span>, title <span class="op">=</span> <span class="st">"Spleen AF"</span> <span class="op">)</span></span></code></pre></div>
<p>This call reads the FCS file, unmixes it, and creates a
self-organizing map (SOM) of the combined raw and unmixed data. Each SOM
node (<code>map$code</code>) is considered an AF signature. Note that
you can increase or decrease the number of spectra generated by changing
the SOM dimensions with argument <code>som.dim</code>. The default
<code>10</code> generates 100 spectra (10 x 10), which works quite well.
It’s likely overkill for simple AF mixtures like PBMCs, but it does not
hurt except for taking longer during the unmixing. If you have really
messy samples, you could play around with larger SOMs, but the default
settings work well for mouse lung, which is pretty terrible for AF.</p>
<p>We get output plots of the AF signatures in the
<code>figure_autofluorescence</code> folder.</p>
<p><img src="figures/Lung_AF_20250909.jpg" alt="Lung AF"><img src="figures/Brain_AF_20250909.jpg" alt="Lung AF"><img src="figures/Spleen_AF_20250909.jpg" alt="Lung AF"></p>
<p>From the variability, I think you can start to understand why it’s
really hard to get good results with single or multiple AF extraction
using the standard method.</p>
<p>There’s also a heatmap generated, but I don’t find this so useful. If
you want, you can probably create some nicer looking plots with some
metaclustering or a dendrogram to group the AF signatures. We don’t use
metaclustering on the SOM nodes because this gives slightly inferior
results in the unmixing.</p>
<div class="float">
<img src="figures/Lung_AF_spectral_heatmap.jpg" alt="Lung AF heatmap"><div class="figcaption">Lung AF heatmap</div>
</div>
<p>Okay, now we’re ready to unmix with per-cell AF extraction.</p>
<p>If you are working with multiple sources like in this example, be
sure to provide the corresponding AF for the unmixing. For example, for
lung cells, provide the lung AF spectra. If you provide a non-matching
AF, it won’t create problems (based on both theory and empirical
testing), but the results will not be as good as if a matching one were
used, simply because the best match won’t be present for all cells. Note
that this means you can use pooled samples as long as you have enough
events acquired, although you may need to increase <code>som.dim</code>
if there are a lot of AF signatures present in each part of the
pool.</p>
<p>While you can call <code>unmix.autospectral</code> directly, this
requires reading in the FCS file into R, extracting the expression data
and so on. The better option is to just call unmix.fcs directly, which
will create an unmixed FCS file from your raw FCS file.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fully.stained.dir</span> <span class="op">&lt;-</span> <span class="st">"./Fully stained"</span></span>
<span></span>
<span><span class="fu"><a href="../reference/unmix.fcs.html">unmix.fcs</a></span><span class="op">(</span> fcs.file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span> <span class="va">fully.stained.dir</span>, <span class="st">"C3 Lung_GFP_003_Samples.fcs"</span> <span class="op">)</span>,</span>
<span>           spectra <span class="op">=</span> <span class="va">spectra</span>,</span>
<span>           asp <span class="op">=</span> <span class="va">asp</span>,</span>
<span>           flow.control <span class="op">=</span> <span class="va">flow.control</span>,</span>
<span>           method <span class="op">=</span> <span class="st">"AutoSpectral"</span>,</span>
<span>           af.spectra <span class="op">=</span> <span class="va">lung.af</span>,</span>
<span>           weighted <span class="op">=</span> <span class="cn">FALSE</span> <span class="op">)</span></span></code></pre></div>
<p>This will use OLS to find the optimal AF per cell. To use WLS, set
<code>weighted = TRUE</code>.</p>
<p>Alternatively, we can call <code>method = "Automatic"</code>, which
is the default. This takes care of the decision making for AF extraction
and weighting automatically. So, if you provide <code>af.spectra</code>,
per-cell AF extraction will be done. Weighting will be used if the data
come from the ID7000, the FACSDiscoverS8 or the FACSDiscoverA8,
attempting to replicate the methodology used on those systems. For
explicit control, call <code>method = "AutoSpectral"</code> as above,
and set the arguments.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/unmix.fcs.html">unmix.fcs</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span> <span class="va">fully.stained.dir</span>, <span class="st">"C3 Lung_GFP_003_Samples.fcs"</span> <span class="op">)</span>,</span>
<span>           <span class="va">spectra</span>,</span>
<span>           <span class="va">asp</span>,</span>
<span>           <span class="va">flow.control</span>,</span>
<span>           af.spectra <span class="op">=</span> <span class="va">lung.af</span> <span class="op">)</span></span></code></pre></div>
<p>Unmixed FCS files will appear in folder
<code>./autospectral_unmixed</code>.</p>
<p>Per-cell AF extraction involves unmixing the data once per AF
signature provided. Since this is a lot of linear algebra, using an
optimized library for linear algebra speeds this process up a lot. We
suggest swapping out the default R BLAS and LAPACK dll files for the
optimized versions in OpenBLAS (or other even better versions). This is
relatively simple to do: <a href="https://github.com/david-cortes/R-openblas-in-windows" class="external-link uri">https://github.com/david-cortes/R-openblas-in-windows</a>
Expect speed ups of ~5x.</p>
<p>Don’t set multiple threads for the BLAS. That will interfere with the
parallel processing used in other parts of AutoSpectral and probably
other R packages.</p>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Oliver Burton, Adrian Liston.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
